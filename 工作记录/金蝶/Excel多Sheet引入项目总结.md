### 功能介绍

背景：在入职开发时，需要一次性导入多张附表，即多个实体到数据库中，由于之前平台只有单实体导入，而且该功能后续也会在其他业务线中用到，所以打算在中台做一个多实体的引入功能。

功能实现：引入时将excel中每个sheet的数据封装成一个个的动态对象实体， 导入到数据库，并且需要考虑后续其他业务线会引入不同实体，不同字段。即要支持配置化引入





### 解决方案思路（面试问了一个导出的场景题，思路可以用作参考）

- 询问有没有模块（业务应用）已经有实现相应功能，有的话可以用作参考

- 如果没有的话问清楚需求，然后在网上查找有没有开源的已知项目用作参考（为什么不用easy excel）

- 考虑功能中有哪些关键问题需要解决

  - excel导出头怎么设计

  - excel导出的行数据怎么设计

- 相关的性能指标要求是多少

### 实现细节

整个导入流程用的生产-消费的设计模式（为什么要用这个设计模式，

一个线程负责将excel中的数据读取出来，解析并且转化为json数据，然后放入阻塞队列中

另一个线程负责从阻塞队列中取数，取到的数据分批处理，每一批数据都单独开一个线程做以下任务

进行基本的业务校验，转化为动态对象实体，数据库入库

所有批次的数据完成以后，将结果进行统计，成功行数，失败行数 返回给前端。



扩展性：

1. 导入的实体和字段模板可自定义配置

2. 为了能够让业务部门能够做一些额外的校验和数据封装等功能的扩展，使用模板模式，在部分事件开放方法允许重写。



### 技术难点和问题

1. 数据进行分批处理时，怎么选择合适的线程数 
2. 目前的话，引入数据的效率到达一个什么样的级别：5s内能够引入1w条行数
3. 在通过CompletableFuture创建异步任务的时候，在性能环境下，遇到了线程的线程池循环引用导致死锁



### 还有哪些地方能够继续优化

   1. 为了让用户能够有好的体验，可以让引入功能后台处理，引入完成以后记录结果，通知用户在引入结果列表查看

      
      
      
      
      

描述技术难点和亮点

难点：

1. 需要引入的数据量大，excel最大行数是100万行，然后考虑极限情况下，公司会有可能有100万条人员数据需要引入；
2. 支持高可扩展，不同的业务线，不同的应用引入的实体，和字段不同，以及中间需要加入的校验也不一致。需要允许配置化开发



解决方案

1. 为了能够在性能上提升，使用生产消息的模式，来平衡生产者和消费者的速度差异。即一个线程负责从excel中读取数据并解析为json对象，放入到阻塞队列中，另一个线程从阻塞队列中分批取数，每一批开一个线程进行后续的任务处理，包括基础的必填校验，字段类型校验等，以及数据库落库。因为需要同步返回给用户一个结果，用countdown 来进行异步转同步，等待所有批次线程都处理完成以后，统计引入结果，失败行数和成功行数，返回给前端。最终的一个效果是10万条数据，能够在10s内完成引入
2. 扩展性方面，允许配置引入模板，在模板中配置实体，以及对应的字段，对应到excel中就是excel头，校验的话，则是在任务处理的过程中，用到了模板模式，将事件开放出来，允许加额外的校验和数据封装。


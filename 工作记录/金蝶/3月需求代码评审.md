### 主业务组织逻辑修改 

PRJ-00253929

需求：

1. PDM增加字段调入主业务组织、调出主业务组织

   只增加一个字段，另一个用之前的修改（org)

2. 元数据修改：

   （1） 调入申请单、调出申请单的调入布局使用调入主业务组织字段；调出申请单、调入申请单的调出布局使用调出主业务组织字段，前段字段名均为主业务组织

   （3） 调出申请单列表的主业务组织字段修改

   （2） 调出申请单主业务组织控权字段修改

3. 逻辑处理：

   发起方为调入，则调入主业务组织=用户选择的值，保存、提交时将调出人事业务组织的值赋值给调出主业务组织；

   （调出人事业务组织取自人事业务档案）
   发起方为调出，则调出主业务组织=用户选择的值，提交时，以及调出审批最后一个节点审批通过时（两个调出申请的工作流），调管理关系策略接口获取人事业务组织的值，赋值给调入主业务组织；（管理关系策略接口之前已有，问冕总   kd.hr.hdm.business.domain.transfer.service.ITransferBillService#setAHrBu）

   新增工作流插件：kd.hr.hdm.formplugin.transfer.web.workflow.out.TransferOutAgreeSetMainOrgPlugin

   注：若调入部门有值，则入参为调入部门、否则入参为调入公司

   代码中其他有用到主业务组织字段的地方都要根据相应的场景选择调入主业务组织或者调出主业务组织: 提交时 excel详情导出， 人员卡片赋值

代码入口：

```
kd.hr.hdm.business.domain.transfer.service.impl.TransferBillServiceImpl#setAMainOrg（setAMainOrg）
```



### 修改调动生效定时任务(对原定时任务改造)    

PRJ-00253921

需求：

1. 如果是批量调动，修改完单据的状态后，需查询改调动单所属的批量调动单，查询所有分录数据状态，若调动状态均为调动完成，则修改批量调动单审批状态=处理完成(分录数据判断时加上终止的数据)，并且需要修改批量调动单调动成功人数字段

代码入口：

```
kd.hr.hdm.business.domain.transfer.service.impl.TransferPersonChangeServiceImpl#updateBatchTransferBillStatus
```



### 批量调动-列表-新增-提交并生效校验、创建事务变动记录、状态变更

PRJ-00253913

需求：

- 校验逻辑同保存:
  1. 必填校验
  2. 数据重复性校验：拿工号查分录数据存在至少两行数据工号一致
  3. 流程中单据校验：所选调动人员有流程中的（调动状态≠调动终止或调动完成）的调动单据	校验不通过，进行弹窗提示（如下图），错误原因：若重复数据的调动类型=批量调动，则错误原因为：已处于调动流程中，批量调动单据编号为%批量调动单据编号%； 否则错误原因为：已处于调动流程中，调动单据编号为%单据编号%
  4. 调动日期与岗位/职位/标准岗位生效日期进行校验：若调动日期＜最早生效日期，则顶部横幅提示
  5. 交叉事务校验
- 状态校验：只可提交并生效暂存的数据
- 列表一次只能提交一条数据
- 查询编制接口校验

处理逻辑：

- 状态变更：

- 占编接口调用

- 是否能够生效调动判断：实际调动日期小于等于当天

  能 ：执行生效逻辑（可以不需要先发提交消息，而直接发生效消息给人事事务）； 

  不能：则只需要人事事务提交消息；

代码入口：

```
kd.hr.hdm.formplugin.transfer.web.batch.BatchTransferEdit#submitEffect
kd.hr.hdm.formplugin.transfer.web.batch.BatchTransferList#submitEffect
kd.hr.hdm.formplugin.transfer.web.batch.BatchTransferOperateResultPlugin
```



### 批量调动-列表-撤销，撤销状态校验、调用事务变动、状态修改

PRJ-00253917

校验：

- 强校验：状态校验，只可对审批中和已提交的进行单据进行撤销
- 弱校验：审批中和已提交的校验，需要进行二次弹窗确认

处理逻辑：

1. 单据状态变为暂存，审批状态变为暂存。
2. 所有分录数据调人事事务终止接口，终止该条变动记录
3. 调用编制释放（有另外的us)
4. 工作流撤销

```
kd.hr.hdm.business.domain.transfer.service.IBatchTransferBillService#unsubmitBatchTransfer
```



### 批量调动-列表-删除校验、删除后删除分录数据和批量调动单数据

PRJ-00253914

校验： 

- 列表只能单条删除
- 只能删除暂存的数据

处理逻辑：

- 删除批量调动单和调动单的分录数据

```
kd.hr.hdm.formplugin.transfer.web.batch.BatchTransferList#excuteBatchTransferOperation
```



### 分录删除逻辑✔

PRJ-00253905

1. 支持批量删除和单个删除
2. 需进行弹窗二次确认：请确认是否删除



### 批量调动权限处理

PRJ-00253923



### 单人调动调入部门及标准岗位的交互修改

PRJ-00268638

```
kd/hr/hdm/formplugin/transfer/web/common/TransferBillPropChangedEdit.java:177
```



### 调动标准岗位、职位F7展示数据范围逻辑调整

PRJ-00276830

```
kd.hr.hdm.formplugin.transfer.web.common.TransferBillPropChangedEdit#setOrgdesignRange
```



## 编制需求

### 【批量调动】终止/撤销/不同意并终止后，编制逻辑处理

PRJ-00253916

```
kd.hr.hdm.business.mq.sender.TransferStaffSend#sendStaffTerminalMsg
```

### 编制检查：流程驳回到提交节点，调编制终止

PRJ-00266252

```
kd.hr.hdm.formplugin.transfer.web.workflow.batch.BatchTransferRejectWorkflowPlugin
```



### 【批量调动】工作流插件：部门/公司修改后先查询编制再预占用编制

PRJ-00266177

```
kd.hr.hdm.opplugin.transfer.BatchTransferApprovalAgreeOp
```



### 【单人调动/岗位调整】工作流插件：部门/公司修改后先查询编制再预占用编制

PRJ-00266179

```
kd.hr.hdm.opplugin.transfer.TransferApprovalAgreeOp
```




## 业务流程设计

### 业务流程

业务流程有两种类型，一个是员工本人发起的离职申请，还有一个是HR发起的离职代申请，两种类型的申请都能在移动端和pc端发起，发起离职申请以后进入流程审批阶段，HR审批，上级审批，主管审批等。以及流程还会触发一系列的离职活动，离职协作（工作交接，竞业协议），离职访谈，离职证明开具。等到了劳动关系结束日会自动触发定时任务离职生效，修改人员主数据，生成离职档案

## 系统设计



### 功能介绍

- HR离职代申请（移动端/pc端）
- 员工离职申请 （移动端/pc端）
- 离职人员的离职活动办理功能
- 到达劳动关系结束日以后离职生效
- 基础资料
- 离职管理总览-工作台



### 数据建模和物理建表

- 离职申请单据
- 离职访谈
- 离职协作
- 离职证明
- 离职指引
- 离职档案基础信息



### 开发实现v0

业务开发使用的框架是苍穹平台自研框架

数据库是Mysql

人员数据查询利用dubbo来进行RPC调用获取

离职生效以后通知下游，利用RabbitMQ发布消息，供下游订阅消费

离职事务和组织编制事务利用TCC保证事务强一致性



### 需要解决的问题和技术方案





### 系统集成

​	人员：获取人员信息，单据生效以后更新人员主数据。 要求可重试，要求幂等，要求记录集成日志

​	组织：获取公司，部门，岗位等信息。 获取编制信息，更新编制。要求强一致性

​	人事事务：交叉事务校验，创建事务变更记录，生效事务变更，撤销事务变更

​	对外提供接口：薪酬， 提供单据查询服务



### 二开扩展：

##### 实施配置：

- 基础资料配置（离职类型，离职指引等）
- 离职活动方案配置
- 工作流配置
- 规则引擎配置

##### 模型可扩展，定制产品可随标准产品升级



## 关键问题和解决方案

1. 到了劳动关系结束日以后离职不生效

   劳动关系结束日小于当天->定时任务正常执行->规则引擎已配置并且确认没有问题->是否发送人事事务消息并且人事事务消费成功->收到人事事务回调结果消息处理是否成功->发布中台消息协同是否成功

​	怎么解决的：

1. 确认环境上包的版本

2. 本地是否能重现

3. monitor查看日志

4. 关键节点打日志

5. 善用F12查看请求
6. 划定责任方，业务问题，其他应用的问题，平台问题，中台问题。
7. 总结

先排除代码问题，lsd是否小于当天，且中台消息协同是否发送成功，如果发送成功了，但是没有生效，那就是代码有问题。否则的话从头开始定位，关键节点都有打日志，通过日志定位具体是在哪个模块出现了问题， 客户现场反馈的问题主要集中两个模块，一个是在规则引擎没有配置策略，或者配置的策略有问题。另一个就是数据问题，由于人员本身的数据问题，等消息发送到人事事务，人事事务进行业务处理的时候，对于必填字段不填或者字段值错误的单据。 






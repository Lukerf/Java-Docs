### 调动重构插件处理✔

PRJ-00253939	

梳理和重构调动部分校验和业务服务逻辑，抽成服务，供二开扩展



### 调入公司逻辑修改✔ （已自测）

PRJ-00253938

1. 变动操作=跨公司的调动时，调入公司可编辑

2. 调入公司F7，不展示调出公司

3. 清空调入公司，则需清空拟调入/调入部门，调入直接上级（任岗模式=岗位）的值； 因为其他的清空职位，岗位都是由于部门清空造成的，所以不用在这里加逻辑



### 单据必填性、编辑性及字段显隐调整✔

PRJ-00253937

1. 调动状态≠调动完成时，不展示实际调动日期字段

2. 调出部门最后工作日在编辑态可进行编辑，且为非必填，可选范围大于等于生效的任职经历的开始日期

   查接口，查任职经历，只取生效的主任职

3. 保存/提交 需要对调出部门最后工作日进行校验,提示语：保存/提交失败，调出部门最后工作日应大于等于生效的全职任职经历开始日期（%任职经历开始日期）  对调动日期校验 保持一致



### ~~调动事务类别数据升级~~

~~PRJ-00253936~~



### ~~调动类别数据升级~~

~~PRJ-00260206~~



### 新增基础资料：调动类别✔

PRJ-00253935

1. 为非受控基础资料（元数据，建模）
2. 预置数据：平调、晋升、降职
3. 调动单新增字段，放在事务变动操作后面，并去掉之前的事务调动类别字段，非必填
3. 调动单菜单配置新增调动类别



### 调入申请：信息变更修改✔  已自测

PRJ-00253928

1. 信息变更允许修改任岗模式
1. 任岗模式变更联动也要和调动单同步

### 主业务组织逻辑修改 ✔

PRJ-00253929

1. PDM增加字段调入主业务组织、调出主业务组织

   只增加一个字段，另一个用之前的修改（org)

2. 元数据修改：

   （1） 调入申请单、调出申请单的调入布局使用调入主业务组织字段；调出申请单、调入申请单的调出布局使用调出主业务组织字段，前段字段名均为主业务组织

   （3） 调出申请单列表的主业务组织字段修改

   （2） 调出申请单主业务组织控权字段修改

3. 逻辑处理：

   发起方为调入，则调入主业务组织=用户选择的值，保存、提交时将调出人事业务组织的值赋值给调出主业务组织；

   （调出人事业务组织取自人事业务档案）
   发起方为调出，则调出主业务组织=用户选择的值，提交时，以及调出审批最后一个节点审批通过时（两个调出申请的工作流），调管理关系策略接口获取人事业务组织的值，赋值给调入主业务组织；（管理关系策略接口之前已有，问冕总   kd.hr.hdm.business.domain.transfer.service.ITransferBillService#setAHrBu）

   新增工作流插件：kd.hr.hdm.formplugin.transfer.web.workflow.out.TransferOutAgreeSetMainOrgPlugin

   注：若调入部门有值，则入参为调入部门、否则入参为调入公司

   代码中其他有用到主业务组织字段的地方都要根据相应的场景选择调入主业务组织或者调出主业务组织: 提交时 excel详情导出， 人员卡片赋值



### ~~主业务组织数据升级~~

~~PRJ-00253934~~

~~①升级范围：主业务组织值不为空的单据~~ 

~~②升级方案：发起方=调出，将用户填写的主业务组织的值赋值给调出主业务组织，调管理关系策略接口获取人事业务组织的值，赋值给调入主业务组织，入参为调入部门； 发起方为调入，将用户填写的主业务组织的值赋值给调入主业务组织，将人事业务组织赋值给调出主业务组织~~

~~插件脚本实现~~

~~只用一个字段方案：即新增调出主业务组织字段，原本的主业务组织字段改为调入主业务组织字段~~

~~发起方=调出，将用户填写的主业务组织的值赋值给调出主业务组织，调管理关系策略接口获取人事业务组织的值，赋值给调入主业务组织，入参为调入部门；~~ 

~~发起方为调入，用户填写的原主业务组织字段不变，人事业务档案的人事业务组织赋值给调出主业务组织~~

### ~~调动人员卡片调整~~

~~PRJ-00255108~~

~~人员卡片抽成公共服务后，业务需要根据具体影响点进行调整~~



### 【岗位调整】人员档案F7要控权（入离调转、合同等）预留US✔   已自测

PRJ-00257623

1. 调出申请单的人事业务档案需勾选引用属性（挂靠行政组织、人事业务组织、人事人员组、所属管理范围）

### 调出/调入申请单元数据修改：调入岗位引用属性勾选上行政组织✔   已自测

PRJ-00268636

1. 修改基础单据，增加引入属性：行政组织

### 调入申请、调出申请业务对象维度映射预置脚本修改✔   已自测

PRJ-00268637

1. 修改维度映射脚本，映射内容参考需归excel文档

### 单人调动调入部门及标准岗位的交互修改

PRJ-00268638



### 权限预置角色脚本升级✔   已自测

PRJ-00269122

1. 预置角色脚本升级：各领域如果有预置的角色，需要把平台角色表的公开状态修改为'0'(私有)，以防止被HR之外的其他领域修改。 需要预置一个脚本，在sys库执行：update t_perm_role set fusescope=0 where fid='预置角色ID'




### 调动协同消息api清单升级✔   已自测

PRJ-00271224

调动所有的中台消息发布api配置增加企业人附表-用工关系记录查询api

## 批量调动需求



### 辅助资料：调动类型✔

PRJ-00253925

1. 新增辅助资料 调动类型
2. 预置数据  1010_S 单人调动 ，1020_S  批量调动
3. 调动单增加调动类型字段（包括pdm建模和元数据加字段）

### 调动类型数据升级✔  已自测

PRJ-00253926

1. 增加脚本删除原本hers的预制辅助资料数据
2. 增加升级脚本：调动类型为空的数据设置为单人调动

### 修改调动生效定时任务(对原定时任务改造)    待自测验证

PRJ-00253921

1. 如果是批量调动，修改完单据的状态后，需查询改调动单所属的批量调动单，查询所有分录数据状态，若调动状态均为调动完成，则修改批量调动单审批状态=处理完成(分录数据判断时加上终止的数据)



### 批量调动-列表-新增-提交并生效校验、创建事务变动记录、状态变更

PRJ-00253913

校验：

- 校验逻辑同保存:
  1. 必填校验
  2. 数据重复性校验：拿工号查分录数据存在至少两行数据工号一致
  3. 流程中单据校验：所选调动人员有流程中的（调动状态≠调动终止或调动完成）的调动单据	校验不通过，进行弹窗提示（如下图），错误原因：若重复数据的调动类型=批量调动，则错误原因为：已处于调动流程中，批量调动单据编号为%批量调动单据编号%； 否则错误原因为：已处于调动流程中，调动单据编号为%单据编号%
  4. 调动日期与岗位/职位/标准岗位生效日期进行校验：若调动日期＜最早生效日期，则顶部横幅提示
  5. 交叉事务校验
  6. 
- 状态校验：只可提交并生效暂存的数据
- 列表一次只能提交一条数据
- 查询编制接口校验

处理逻辑：

- 状态变更：

- 占编接口调用

- 是否能够生效调动判断：实际调动日期小于等于当天

  能 ：执行生效逻辑（可以不需要先发提交消息，而直接发生效消息给人事事务）； 

  不能：则只需要人事事务提交消息；



### 批量调动-列表-撤销，撤销状态校验、调用事务变动、状态修改

PRJ-00253917

校验：

- 强校验：状态校验，只可对审批中和已提交的进行单据进行撤销
- 弱校验：审批中和已提交的校验，需要进行二次弹窗确认

处理逻辑：

1. 单据状态变为暂存，审批状态变为暂存。

2. 所有分录数据调人事事务终止接口，终止该条变动记录
3. 调用编制释放（有另外的us)



### 批量调动-列表-删除校验、删除后删除分录数据和批量调动单数据

PRJ-00253914

校验： 

- 列表只能单条删除
- 只能删除暂存的数据

处理逻辑：

- 删除批量调动单和调动单的分录数据



### 分录删除逻辑✔

PRJ-00253905

1. 支持批量删除和单个删除
2. 需进行弹窗二次确认：请确认是否删除



### 批量调动权限处理

PRJ-00253923

内容需补充



## 编制需求

### 【批量调动】终止/撤销/不同意并终止后，编制逻辑处理

PRJ-00253916

编制相关



### 【批量调动】工作流插件：部门/公司修改后先查询编制再预占用编制

PRJ-00266177



### 【单人调动/岗位调整】工作流插件：部门/公司修改后先查询编制再预占用编制

PRJ-00266179



### 编制检查：流程驳回到提交节点，调编制终止

PRJ-00266252

